---
layout:     post
title:      "第一章：How the Internet Works"
author:     "lili"
mathjax: true
sticky: false
excerpt_separator: <!--more-->
tags:
    - python
    - scraping
---

<!--more-->
**目录**
* TOC
{:toc}

我这一生中遇到的真正了解互联网工作原理的人寥寥无几，而我显然不在其中。我们大多数人只是凭借一套能够让我们恰到好处地使用互联网的心理抽象来应付。即使对于程序员来说，这些抽象也可能仅仅扩展到他们在职业生涯中曾经解决过的某个特别棘手的问题所需的程度。

由于页面篇幅的限制和作者知识的局限，本章也不得不依赖这些抽象。它描述了互联网和 Web 应用程序的机制，尽可能涵盖了爬取网页所需的内容（或许还多一点点）。在某种意义上，本章描述了网络爬虫所运行的世界：习俗、做法、协议和标准，这些将在整本书中不断被提及。

当你在网络浏览器的地址栏中输入 URL 并按下回车键时，交互式文本、图像和媒体就会像魔法般地出现。这种魔法每天都在为数十亿人身上发生。他们访问着相同的网站，使用着相同的应用程序——经常获取到专门为他们定制的媒体和文本。

这数十亿人使用着不同类型的设备和软件应用程序，这些程序是由不同的开发人员在不同的（通常是竞争的！）公司编写的。令人惊讶的是，没有一个全能的监管机构通过法律力量来规范互联网并协调其发展。相反，互联网的不同部分是由一些随着时间推移逐渐形成的不同组织治理的，这些组织在一定程度上是临时和自愿加入的。

当然，选择不遵循这些组织发布的标准可能会导致你对互联网的贡献根本……无法运作。如果你的网站无法在流行的网络浏览器中显示，人们很可能不会访问它。如果你的路由器发送的数据无法被其他任何路由器解析，那些数据将被忽略。

网络爬取本质上是用你自己设计的应用程序替代网络浏览器的行为。正因为如此，理解网络浏览器所依赖的标准和框架是非常重要的。作为一个网络爬虫，你必须既要模仿，又有时要颠覆预期的互联网习俗和做法。

## 网络

在电话系统的早期，每部电话都通过一根实物电线连接到一个中央交换机板。如果你想打电话给附近的朋友，你拿起电话，要求接线员帮你接通，接线员通过插头和插孔物理地创建一条你和朋友之间的专线连接。

长途电话费用昂贵，而且可能需要几分钟才能接通。从波士顿拨打到西雅图的长途电话会涉及全美各地的接线员协调，创建一条直接连接你电话和接收者电话的长电线。

如今，我们不再通过临时专线打电话，而是可以通过一张持久的电线网络从家里拨打视频电话到世界任何地方。这些电线不会告诉数据该去哪里，数据自己引导自己，这个过程被称为分组交换(packet switching)。尽管多年来许多技术对我们所称的“互联网”有所贡献，但真正单独启动这一切的技术是分组交换。

在分组交换网络中，要发送的消息被分成离散的有序分组，每个分组都有自己的发送者和接收者地址。这些分组根据地址动态路由到网络上的任何目的地。与必须盲目穿过从接收者到发送者的单一专线不同，这些分组可以走任何网络选择的路径。事实上，同一消息传输中的分组可能会通过网络中的不同路线，在到达时由接收计算机重新排序。

如果说旧的电话网络像是一条索道——将乘客从山顶的一个目的地带到山底的另一个目的地——那么分组交换网络就像是一条高速公路系统，来往多个目的地的汽车都可以使用同样的道路。

现代的分组交换网络通常使用开放系统互连（OSI）模型来描述，该模型由七层路由、编码和错误处理组成：

* 物理层
* 数据链路层
* 网络层
* 传输层
* 会话层
* 表示层
* 应用层

大多数 Web 应用程序开发人员的工作完全在第七层，即应用层。这也是本书中花费最多时间的一层。然而，在爬取网页时，了解其他层次的概念知识也是重要的。例如，第17章讨论的 TLS 指纹识别(TLS fingerprinting)是一种涉及传输层的 Web 爬虫检测方法。

此外，了解所有的数据封装和传输层次有助于解决 Web 应用程序和 Web 爬虫中的错误。



### 物理层

物理层指定了信息如何通过你家中的以太网电缆（或任何本地网络）以电信号的形式进行物理传输。它定义了编码1和0的电压水平，以及这些电压脉冲的速度。它还定义了通过蓝牙和 WiFi 传输的无线电波如何被解释。

这一层不涉及任何编程或数字指令，而是纯粹基于物理和电气标准。

### 数据链路层

数据链路层规定了信息如何在本地网络的两个节点之间传输，例如，在你的计算机和路由器之间。它定义了一次传输的开始和结束，并在传输丢失或出现错误时提供纠错功能。

在这一层，数据包被包装在一个额外的“数字信封”中，包含路由信息，并被称为帧(frame)。当帧中的信息不再需要时，它被解封并作为数据包发送到网络中。

需要注意的是，在数据链路层，网络上的所有设备都在同时接收相同的数据——没有实际的“切换”或控制数据的去向。然而，数据未被发送到的设备通常会忽略数据，直到它们接收到为它们发送的数据。

### 网络层

网络层是分组交换发生的地方，因此也是“互联网”发生的地方。这一层允许你的计算机的数据包通过路由器转发并到达其直接网络之外的设备。

网络层涉及传输控制协议/互联网协议（TCP/IP）中的互联网协议（IP）。IP 是我们获取 IP 地址的地方。例如，我在全球互联网的 IP 地址目前是 173.48.178.92。这允许世界上的任何计算机向我发送数据，我也可以从我的地址向任何其他地址发送数据。

### 传输层

第4层，即传输层，关注的是将运行在一台计算机上的特定服务或应用程序连接到另一台计算机上运行的特定应用程序，而不仅仅是连接计算机本身。它还负责数据流中的任何错误纠正或重试。

例如，TCP 非常严格，会不断请求丢失的包，直到所有包都正确接收。TCP 通常用于文件传输，其中所有包必须按正确顺序正确接收，以使文件正常工作。

相比之下，用户数据报协议（UDP）则会高兴地跳过丢失的包，以保持数据流动。它通常用于视频会议或音频会议，其中传输质量的暂时下降比对话中的延迟更可取。

因为你的计算机上的不同应用程序在同一时间可能有不同的数据可靠性需求（例如，一边打电话一边下载文件），传输层也是端口号起作用的地方。操作系统为运行在你计算机上的每个应用程序或服务分配一个特定的端口，通过该端口发送和接收数据。

这个端口通常写成 IP 地址后面的一个数字，用冒号分隔。例如，71.245.238.173:8080 表示操作系统分配给 IP 地址为 71.245.238.173 的计算机上的端口 8080 的应用程序。


### 会话层

会话层负责在两个应用程序之间开启和关闭会话。这个会话允许保存关于哪些数据已发送和未发送、以及计算机与谁通信的状态信息。会话通常在完成数据请求所需的时间内保持打开状态，然后关闭。

会话层允许在短暂崩溃或断开连接的情况下重试传输。

**会话与会话**

OSI 模型的会话层中的会话与 Web 开发人员通常谈论的会话和会话数据不同。Web 应用程序中的会话变量是应用层的一个概念，由 Web 浏览器软件实现。应用层中的会话变量会在浏览器中保存，直到需要或用户关闭浏览器窗口为止。在 OSI 模型的会话层中，会话通常只持续传输单个文件所需的时间。

### 表示层

表示层将传入的数据从字符字符串转换为应用程序可以理解和使用的格式。它还负责字符编码和数据压缩。表示层关心的是接收到的数据显示的是 PNG 文件还是 HTML 文件，并相应地将该文件交给应用层。

### 应用层

应用层解释由表示层编码的数据，并将其适当地用于应用程序。我喜欢将表示层看作是负责转换和识别事物，而应用层则负责“执行”事物。例如，HTTP 及其方法和状态是应用层协议。更平凡的 JSON 和 HTML（因为它们是定义数据如何编码的文件类型）是表示层协议。



## HTML

Web 浏览器的主要功能是显示 HTML（超文本标记语言）文档。HTML 文档是以 .html 或较少见的 .htm 结尾的文件。

像文本文件一样，HTML 文件使用纯文本字符编码，通常是 ASCII（详见第 147 页的“文本编码和全球互联网”）。这意味着它们可以用任何文本编辑器打开和阅读。

以下是一个简单的 HTML 文件示例：

```html
<html>
    <head>
        <title>A Simple Webpage</title>
    </head>
    <body>
        <!-- This comment text is not displayed in the browser -->
        <h1>Hello, World!</h1>
    </body>
</html>
```

HTML 文件是一种特殊类型的 XML（可扩展标记语言）文件。每个以 \< 开头并以 > 结尾的字符串称为标签。

XML 标准定义了像 \<html> 这样的起始标签和像 \</html> 这样的结束标签。起始和结束标签之间是标签的内容。

在某些情况下，标签不需要任何内容，这时你可能会看到一个自闭合标签。自闭合标签或空元素标签的样子如下：

```html
<p />
```

标签还可以包含属性，形式为 attributeKey="attribute value"，例如：

```html
<div class="content">
Lorem ipsum dolor sit amet, consectetur adipiscing elit
</div>
```

这里，div 标签具有 class 属性，其值为 main-content。

HTML 元素包括一个带有一些可选属性的起始标签，一些内容和一个结束标签。一个元素还可以包含多个其他元素，在这种情况下它们是嵌套元素。

虽然 XML 定义了标签、内容、属性和值的基本概念，但 HTML 定义了这些标签可以和不能是什么，它们可以和不能包含什么，以及浏览器必须如何解释和显示它们。

例如，HTML 标准定义了 class 属性和 id 属性的用法，它们通常用于组织和控制 HTML 元素的显示：

```html
<h1 id="main-title">Some Title</h1>
<div class="content">
Lorem ipsum dolor sit amet, consectetur adipiscing elit
</div>
```

通常，页面上的多个元素可以包含相同的 class 值；然而，在该页面上 id 字段的任何值必须是唯一的。因此，多个元素可以具有 class content，但只能有一个元素具有 id main-title。

HTML 文档中的元素在 Web 浏览器中的显示方式完全取决于 Web 浏览器作为软件的编程方式。如果一个 Web 浏览器被编程为与另一个 Web 浏览器不同地显示元素，这将导致不同 Web 浏览器的用户体验不一致。

因此，协调 HTML 标签的具体作用并将其编写为统一标准非常重要。HTML 标准目前由万维网联盟（W3C）控制。所有 HTML 标签的当前规范可以在 https://html.spec.whatwg.org/multipage/ 找到。

然而，如果你从未接触过 HTML，正式的 W3C HTML 标准可能不是学习 HTML 的最佳途径。网页抓取的大部分工作涉及读取和解释在网上找到的原始 HTML 文件。如果你从未处理过 HTML，我强烈推荐《HTML & CSS: The Good Parts》这样的书来熟悉一些更常见的 HTML 标签。



## CSS

层叠样式表（CSS）定义了网页上 HTML 元素的外观。CSS 定义了布局、颜色、位置、大小和其他属性，使一个带有浏览器默认样式的无聊的 HTML 页面变得更加吸引现代网页浏览者。

使用前面的 HTML 示例：

```html
<html>
    <head>
        <title>A Simple Webpage</title>
    </head>
    <body>
        <!-- This comment text is not displayed in the browser -->
        <h1>Hello, World!</h1>
    </body>
</html>
```

相应的 CSS 可能是：

```css
h1 {
    font-size: 20px;
    color: green;
}
```

这个 CSS 将 h1 标签的内容字体大小设置为 20 像素，并将其显示为绿色文本。

CSS 中的 h1 部分被称为选择器或 CSS 选择器。这个 CSS 选择器表明大括号内的 CSS 将应用于任何 h1 标签的内容。

CSS 选择器还可以编写为仅应用于具有特定 class 或 id 属性的元素。例如，使用以下 HTML：

```html
<h1 id="main-title">Some Title</h1>
<div class="content">
    Lorem ipsum dolor sit amet, consectetur adipiscing elit
</div>
```

相应的 CSS 可能是：

```css
h1#main-title {
    font-size: 20px;
}

div.content {
    color: green;
}
```

\#用于指示 id 属性的值，而 . 用于指示 class 属性的值。

如果标签的值不重要，则可以完全省略标签名。例如，这个 CSS 将使任何具有 content 类的元素内容变为绿色：

```css
.content {
color: green;
}
```


CSS 数据可以包含在 HTML 本身中，也可以在扩展名为 .css 的单独 CSS 文件中。HTML 文件中的 CSS 放置在 HTML 文档头部的 \<style>标签内：

```html
<html>
    <head>
        <style>
            .content {
                color:green;
            }
        </style>
...
```

更常见的是，CSS 使用 link 标签导入到文档头部：

```html
<html>
    <head>
        <link rel="stylesheet" href="mystyle.css">
...
```

作为一个网页抓取器，你不常需要编写样式表来美化 HTML。然而，能够读取和识别 HTML 页面如何被 CSS 转换是很重要的，这样你才能将你在网页浏览器中看到的内容与代码中看到的内容联系起来。

例如，当 HTML 元素没有出现在页面上时，你可能会感到困惑。当你阅读元素应用的 CSS 时，你会看到：

```css
.mystery-element {
    display: none;
}
```

这将元素的 display 属性设置为 none，从页面中隐藏它。

如果你以前从未接触过 CSS，你可能不需要深入研究它来抓取网页，但你应该熟悉它的语法，并注意本书中提到的 CSS 规则。




## JavaScript

当客户端向网络服务器请求特定的网页时，网络服务器会执行一些代码来创建发送回的网页。这些代码称为服务器端代码，可以简单到检索静态 HTML 文件并发送它，也可以是用 Python（最好的语言）、Java、PHP 或任何常见的服务器端编程语言编写的复杂应用程序。

最终，这些服务器端代码创建了一些数据流，发送到浏览器并显示。但是，如果你想要一些交互或行为——比如文本更改或拖放元素——发生而不需要返回服务器运行更多代码，你需要使用客户端代码。

客户端代码是由网络服务器发送的但实际由客户端浏览器执行的任何代码。在互联网早期（2000年之前），客户端代码是用多种语言编写的。例如，你可能还记得 Java 小程序和 Flash 应用程序。但是 JavaScript 作为客户端代码的唯一选项出现是有一个简单的原因：它是浏览器本身支持的唯一语言，无需下载和更新单独的软件（如 Adobe Flash Player）就可以运行程序。

JavaScript 起源于90年代中期，作为 Netscape Navigator 中的一个新功能。它很快被 Internet Explorer 接受，成为当时两大主流网络浏览器的标准。

尽管名字相似，JavaScript 与服务器端编程语言 Java 几乎没有任何关系。除了一小部分表面上的语法相似之外，它们是完全不同的语言。

1996年，Netscape（JavaScript 的创建者）和 Sun Microsystems（Java 的创建者）签订了许可协议，允许 Netscape 使用名称“JavaScript”，预示着两种语言之间进一步合作。然而，这种合作从未发生过，自那时以来一直是一个令人困惑的误称。

尽管作为一个已经消亡的网络浏览器的脚本语言，JavaScript 的开始有些不确定，但现在它是世界上最流行的编程语言。它的流行程度得益于它也可以用于服务器端，使用 Node.js。但它的流行程度肯定也得益于它是唯一的客户端编程语言。

JavaScript 被嵌入到 HTML 页面中使用 \<script> 标签。JavaScript 代码可以作为内容插入：

```javascript
<script>
    alert('Hello, world');
</script>
```

或者可以使用 src 属性引用在单独文件中的 JavaScript：

```html
<script src="someprogram.js"></script>
```


与 HTML 和 CSS 不同，你在抓取网页时可能不需要阅读或编写 JavaScript，但至少了解一下它的语法会很有用。有时它可能包含有用的数据。例如：

```javascript
<script>
const data = '{"some": 1, "data": 2, "here": 3}';
</script>
```

这里，使用关键字 const（代表“常量”）声明了一个 JavaScript 变量，并设置为一个包含一些数据的 JSON 格式化字符串，可以被网页抓取器直接解析。

JSON（JavaScript 对象表示法）是一种包含人类可读数据的文本格式，可以被网页抓取器轻松解析，也是在网络上普遍存在的。我将在第15章中进一步讨论它。

你可能也会看到 JavaScript 向完全不同的来源请求数据：

```javascript
<script>
    fetch('http://example.com/data.json')
        .then((response) => {
            console.log(response.json());
        });
</script>
```

这里，JavaScript 正在创建一个对 http://example.com/data.json 的请求，并在接收到响应后将其记录到控制台中（关于“控制台”的更多信息将在下一节中讨论）。

JavaScript 最初是为了在原本静态的网络中提供动态互动和动画而创建的。然而，今天，并不是所有的动态行为都是由 JavaScript 创建的。HTML 和 CSS 也有一些功能，使它们可以在页面上更改内容。

例如，CSS 关键帧动画可以让元素在用户单击或悬停在该元素上时移动、更改颜色、更改大小或进行其他转换。

认识到网站的（通常是字面上的）运动部分是如何组合在一起的，可以帮助你在尝试定位数据时避免无用功。

## 观察网站使用开发者工具

就像珠宝商的放大镜或心脏病医生的听诊器一样，你的浏览器开发者工具对于网络抓取至关重要。要从网站收集数据，你必须了解它是如何组成的。开发者工具就能展示给你这些信息。

在本书中，我将使用 Google Chrome 中显示的开发者工具。然而，Firefox、Microsoft Edge 和其他浏览器中的开发者工具都非常相似。

要访问你的浏览器菜单中的开发者工具，请按照以下说明操作：

**Chrome**

查看→ 开发者 → 开发者工具

**Safari**

Safari → 首选项 → 高级 → 勾选“在菜单栏中显示‘开发’菜单”
然后，使用“开发”菜单：开发 → 显示网页检查器

**Microsoft Edge**

使用菜单：工具 → 开发者 → 开发者工具

**Firefox**

工具 → 浏览器工具 → Web 开发者工具

在所有浏览器中，打开开发者工具的键盘快捷键是相同的，取决于你的操作系统。

**Mac**

Option + Command + I

**Windows**

CTRL + Shift + I

在进行网络抓取时，你可能会大部分时间都在网络选项卡（如图1-1所示）和元素选项卡中。

<a>![](/img/scraping/ch1/1.png)</a>
*图1-1. Chrome开发者工具显示来自维基百科的页面加载*

网络选项卡显示页面加载时页面发出的所有请求。如果你之前没有使用过它，你可能会感到惊讶！复杂页面加载时通常会发出数十甚至数百个请求以获取资产。在某些情况下，页面甚至可能会在你停留期间持续不断地发送请求。例如，它们可能正在向行动跟踪软件发送数据，或者轮询更新。

**在网络选项卡中看不到任何内容？**

请注意，开发者工具必须在页面发出请求时打开，才能捕获这些请求。如果你加载页面时没有打开开发者选项卡，然后决定检查它，你可能需要刷新页面以重新加载并查看它发出的请求。

如果你在网络选项卡中单击一个单独的网络请求，你将看到与该请求相关的所有数据。这个网络请求检查工具的布局在不同的浏览器中略有不同，但通常允许你看到：

* 请求发送的 URL
* 使用的 HTTP 方法
* 响应状态
* 与请求相关的所有头和 Cookie
* 负载
* 响应

这些信息对于编写网络抓取器以复制这些请求以获取页面所获取的数据非常有用。

元素选项卡用于检查 HTML 文件的结构和内容。它非常方便，可以检查页面上特定数据的 HTML 标签周围，并编写抓取器来获取它。

<a>![](/img/scraping/ch1/2.png)</a>
*图1-2. 右键单击任何文本或数据，并选择检查以查看在“元素”选项卡中围绕该数据的元素*

当你在元素选项卡中悬停在每个 HTML 元素的文本上时，你会看到浏览器中相应的元素在视觉上高亮显示。使用这个工具是探索页面和更深入了解其结构的好方法。

<a>![](/img/scraping/ch1/3.png)</a>
*图1-3. 在HTML中悬停在元素上会突出显示页面上相应的结构*

你不需要成为互联网、网络或编程的专家就可以开始抓取网络。然而，了解这些组件如何组合以及你的浏览器的开发者工具如何显示这些组件的基础知识是必不可少的。
















 




