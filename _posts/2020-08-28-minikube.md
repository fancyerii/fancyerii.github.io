---
layout:     post
title:      "ä½¿ç”¨minikubeå®‰è£…å•æœºæµ‹è¯•Kubernetesé›†ç¾¤" 
author:     "lili" 
mathjax: true
excerpt_separator: <!--more-->
tags:
    - minikube
    - Kubernetes 
    - Ubuntu
---

æœ¬æ–‡ä»‹ç»ä½¿ç”¨minikubeå®‰è£…å•æœºæµ‹è¯•Kubernetesé›†ç¾¤ï¼Œä¸»è¦æ˜¯è§£å†³å› ä¸ºå¢™å¸¦æ¥çš„å„ç§é—®é¢˜ã€‚ä¸ºäº†è®©å¹¿å¤§å±€åŸŸç½‘ç”¨æˆ·ç”¨ä¸Šk8sï¼Œminikube startè¿˜ç‰¹åœ°å¢åŠ äº†image-mirror-countryå‚æ•°ï¼Œå’±ç»ˆäºäº«å—åˆ°ç‰¹ä¾›çš„å¾…é‡äº†ã€‚è¿™é‡Œçš„Hostç³»ç»Ÿæ˜¯Ubuntu 16.04ï¼Œå…¶å®ƒç³»ç»Ÿè¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼Œéœ€è¦ç¿»å¢™æˆ–è€…è®¾ç½®mirrorçš„åœ°æ–¹å¯ä¾›å‚è€ƒã€‚

<!--more-->

**ç›®å½•**
* TOC
{:toc}

## å®‰è£…

### æ£€æŸ¥è™šæ‹ŸåŒ–çš„æ”¯æŒ

```
$ grep -E --color 'vmx|svm' /proc/cpuinfo
```
å¦‚æœä¸Šé¢çš„å‘½ä»¤è¿”å›çš„ä¸æ˜¯ç©ºå°±okã€‚

### å®‰è£…kubectl

kubectlçš„å®‰è£…å¯ä»¥å‚è€ƒ[è¿™é‡Œ](https://kubernetes.io/docs/tasks/tools/install-kubectl/)ï¼Œéš¾ç‚¹æ˜¯ç§‘å­¦ä¸Šç½‘ä¸‹è½½ã€‚
è¿™æ˜¯æˆ‘å®‰è£…çš„kubectlç‰ˆæœ¬ï¼š

```
$ kubectl version
Client Version: version.Info{Major:"1", Minor:"18", GitVersion:"v1.18.3", GitCommit:"2e7996e3e2712684bc73f0dec0200d64eec7fe40", GitTreeState:"clean", BuildDate:"2020-05-20T12:52:00Z", GoVersion:"go1.13.9", Compiler:"gc", Platform:"linux/amd64"}
Server Version: version.Info{Major:"1", Minor:"18", GitVersion:"v1.18.3", GitCommit:"2e7996e3e2712684bc73f0dec0200d64eec7fe40", GitTreeState:"clean", BuildDate:"2020-05-20T12:43:34Z", GoVersion:"go1.13.9", Compiler:"gc", Platform:"linux/amd64"}
```

å¦‚æœç¿»ä¸äº†å¢™çš„åŒå­¦ä¹Ÿå¯ä»¥è¯•è¯•aptå®‰è£…ï¼Œä¸è¿‡ç‰ˆæœ¬å¯èƒ½ä¼šæ—§ä¸€ç‚¹ï¼š
```
$ curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
$ sudo touch /etc/apt/sources.list.d/kubernetes.list 
$ echo "deb http://apt.kubernetes.io/ kubernetes-xenial main" | sudo tee -a /etc/apt/sources.list.d/kubernetes.list
$ sudo apt-get update
$ sudo apt-get install -y kubectl
```
### å®‰è£…ä¸€ç§Hypervisor

æˆ‘ä»¬è¿™é‡Œå®‰è£…virtualboxï¼Œé¦–å…ˆå®‰è£…ä¾èµ–ï¼š
```
$ sudo apt-get update
$ sudo apt-get install -y apt-transport-https
```
ç„¶åå®‰è£…virtualboxï¼š
```
$ sudo apt-get install -y virtualbox virtualbox-ext-pack
```

### å®‰è£…minicube

ä¸‹è½½ï¼š
```
$ curl -Lo minikube https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64 \
  && chmod +x minikube
``` 

å¤åˆ¶åˆ°/usr/local/binï¼š

```
sudo mkdir -p /usr/local/bin/
sudo cp minikube /usr/local/bin/
```

### å¯åŠ¨

è¿™æ˜¯æœ€å…³é”®çš„åœ°æ–¹ï¼Œæˆ‘ä¹‹å‰å°è¯•ç¿»å¢™ï¼Œä½†æ˜¯å› ä¸ºè¦å»gcr.ioä¸‹è½½å¾ˆå¤§çš„imageï¼Œè¿˜æ˜¯å¾ˆéš¾æˆåŠŸã€‚è¿˜å¥½æœ‰image-mirror-countryï¼š

```
$ minikube start --image-mirror-country='cn' --image-repository='registry.cn-hangzhou.aliyuncs.com/google_containers'
```

ç¬¬ä¸€æ¬¡è¿è¡Œæ—¶éœ€è¦æ‹‰å¾ˆå¤šé•œåƒï¼Œä¸­é—´å¯èƒ½ä¼šé‡è¯•å‡ æ¬¡ï¼Œä¼šæ¯”è¾ƒæ…¢ï¼Œç»è¿‡ä¸€æ®µæ—¶é—´ä¹‹åå°±ä¼šæˆåŠŸå¯åŠ¨ï¼š

```
$ minikube start --image-mirror-country='cn' --image-repository='registry.cn-hangzhou.aliyuncs.com/google_containers' 
ğŸ˜„  Ubuntu 16.04 ä¸Šçš„ minikube v1.12.3
âœ¨  Automatically selected the docker driver. Other choices: kvm2, virtualbox
âœ…  æ­£åœ¨ä½¿ç”¨é•œåƒå­˜å‚¨åº“ registry.cn-hangzhou.aliyuncs.com/google_containers
ğŸ‘  Starting control plane node minikube in cluster minikube
ğŸšœ  Pulling base image ...
E0828 16:50:34.140667 1129053 cache.go:63] save image to file "registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.18.3" -> "/home/lili/.minikube/cache/images/registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager_v1.18.3" failed: write: unexpected EOF
E0828 16:51:21.087078 1129053 cache.go:63] save image to file "registry.cn-hangzhou.aliyuncs.com/google_containers/storage-provisioner:v2" -> "/home/lili/.minikube/cache/images/registry.cn-hangzhou.aliyuncs.com/google_containers/storage-provisioner_v2" failed: write: unexpected EOF
E0828 16:51:23.083770 1129053 cache.go:63] save image to file "registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:1.6.7" -> "/home/lili/.minikube/cache/images/registry.cn-hangzhou.aliyuncs.com/google_containers/coredns_1.6.7" failed: write: unexpected EOF

ğŸ”¥  Creating docker container (CPUs=2, Memory=7900MB) ...
ğŸ¤¦  StartHost failed, but will try again: creating host: create: creating: setting up container node: preparing volume for minikube container: docker run --rm --entrypoint /usr/bin/test -v minikube:/var gcr.io/k8s-minikube/kicbase:v0.0.11@sha256:6fee59db7d67ed8ae6835e4bcb02f32056dc95f11cb369c51e352b62dd198aa0 -d /var/lib: exit status 125
stdout:

stderr:
Unable to find image 'gcr.io/k8s-minikube/kicbase:v0.0.11@sha256:6fee59db7d67ed8ae6835e4bcb02f32056dc95f11cb369c51e352b62dd198aa0' locally
docker: Error response from daemon: Get https://gcr.io/v2/: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers).
See 'docker run --help'.

ğŸ¤·  docker "minikube" container is missing, will recreate.
ğŸ”¥  Creating docker container (CPUs=2, Memory=7900MB) ...


ğŸ˜¿  Failed to start docker container. "minikube start" may fix it: recreate: creating host: create: creating: setting up container node: preparing volume for minikube container: docker run --rm --entrypoint /usr/bin/test -v minikube:/var gcr.io/k8s-minikube/kicbase:v0.0.11@sha256:6fee59db7d67ed8ae6835e4bcb02f32056dc95f11cb369c51e352b62dd198aa0 -d /var/lib: exit status 125
stdout:

stderr:
Unable to find image 'gcr.io/k8s-minikube/kicbase:v0.0.11@sha256:6fee59db7d67ed8ae6835e4bcb02f32056dc95f11cb369c51e352b62dd198aa0' locally
docker: Error response from daemon: Get https://gcr.io/v2/: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers).
See 'docker run --help'.

â—  Startup with docker driver failed, trying with alternate driver kvm2: Failed to start host: recreate: creating host: create: creating: setting up container node: preparing volume for minikube container: docker run --rm --entrypoint /usr/bin/test -v minikube:/var gcr.io/k8s-minikube/kicbase:v0.0.11@sha256:6fee59db7d67ed8ae6835e4bcb02f32056dc95f11cb369c51e352b62dd198aa0 -d /var/lib: exit status 125
stdout:

stderr:
Unable to find image 'gcr.io/k8s-minikube/kicbase:v0.0.11@sha256:6fee59db7d67ed8ae6835e4bcb02f32056dc95f11cb369c51e352b62dd198aa0' locally
docker: Error response from daemon: Get https://gcr.io/v2/: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers).
See 'docker run --help'.

ğŸ”¥  æ­£åœ¨åˆ é™¤ docker ä¸­çš„â€œminikubeâ€â€¦
ğŸ”¥  æ­£åœ¨ç§»é™¤ /home/lili/.minikube/machines/minikubeâ€¦
ğŸ’€  Removed all traces of the "minikube" cluster.
ğŸ’¾  æ­£åœ¨ä¸‹è½½é©±åŠ¨ docker-machine-driver-kvm2:
    > docker-machine-driver-kvm2.sha256: 65 B / 65 B [-------] 100.00% ? p/s 0s
    > docker-machine-driver-kvm2: 13.81 MiB / 13.81 MiB  100.00% 109.22 KiB p/s
âœ…  æ­£åœ¨ä½¿ç”¨é•œåƒå­˜å‚¨åº“ registry.cn-hangzhou.aliyuncs.com/google_containers
ğŸ’¿  æ­£åœ¨ä¸‹è½½ VM boot image...
    > minikube-v1.12.2.iso.sha256: 65 B / 65 B [-------------] 100.00% ? p/s 0s
    > minikube-v1.12.2.iso: 173.73 MiB / 173.73 MiB  100.00% 582.39 KiB p/s 5m6
ğŸ‘  Starting control plane node minikube in cluster minikube
ğŸ”¥  Creating kvm2 VM (CPUs=2, Memory=6000MB, Disk=20000MB) ...
â—  This VM is having trouble accessing https://registry.cn-hangzhou.aliyuncs.com/google_containers
ğŸ’¡  To pull new external images, you may need to configure a proxy: https://minikube.sigs.k8s.io/docs/reference/networking/proxy/
E0828 17:14:18.228053 1129053 cache.go:190] Error caching images:  Caching images for kubeadm: caching images: caching image "/home/lili/.minikube/cache/images/registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager_v1.18.3": write: unexpected EOF
ğŸ³  æ­£åœ¨ Docker 19.03.12 ä¸­å‡†å¤‡ Kubernetes v1.18.3â€¦
    > kubelet.sha256: 65 B / 65 B [--------------------------] 100.00% ? p/s 0s
    > kubeadm.sha256: 65 B / 65 B [--------------------------] 100.00% ? p/s 0s
    > kubectl.sha256: 65 B / 65 B [--------------------------] 100.00% ? p/s 0s
    > kubeadm: 37.97 MiB / 37.97 MiB [-----------] 100.00% 173.12 KiB p/s 3m45s
    > kubectl: 41.99 MiB / 41.99 MiB [-----------] 100.00% 149.93 KiB p/s 4m47s
    > kubelet: 108.04 MiB / 108.04 MiB [---------] 100.00% 355.32 KiB p/s 5m11s
ğŸ”  Verifying Kubernetes components...
ğŸŒŸ  Enabled addons: default-storageclass, storage-provisioner
ğŸ„  å®Œæˆï¼kubectl å·²ç»é…ç½®è‡³ "minikube"

```

ä¸å®¹æ˜“ï¼ç»ˆäºæˆåŠŸäº†ï¼Œæˆ‘ä»¬éªŒè¯ä¸€ä¸‹ï¼š

```
$ minikube status
minikube
type: Control Plane
host: Running
kubelet: Running
apiserver: Running
kubeconfig: Configured
```

æ¥ç€å¯ä»¥å¯åŠ¨dashboardï¼Œå›¾å½¢ç•Œé¢çœ‹èµ·æ¥ä¼šæ¯”è¾ƒå¥½ï¼š

```
minikube dashboard
ğŸ¤”  æ­£åœ¨éªŒè¯ dashboard è¿è¡Œæƒ…å†µ ...
ğŸš€  Launching proxy ...
ğŸ¤”  æ­£åœ¨éªŒè¯ proxy è¿è¡ŒçŠ¶å†µ ...
ğŸ‰  Opening http://127.0.0.1:42191/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/ in your default browser...
```

å¦‚æœä¸€åˆ‡é¡ºåˆ©çš„è¯ä¼šå¼¹å‡ºæµè§ˆå™¨ã€‚

### åˆ›å»ºDeployment

æˆ‘ä»¬ä½¿ç”¨echo-serveråˆ›å»ºDeploymentï¼Œæ³¨æ„ä¸è¦ä½¿ç”¨å¢™å¤–çš„ï¼š

```
$ kubectl create deployment hello-minikube --image=registry.aliyuncs.com/google_containers/echoserver:1.10
```

### å¯¼å‡ºService

```
kubectl expose deployment hello-minikube --type=NodePort --port=8080
```

### æŸ¥çœ‹çŠ¶æ€

```
kubectl get pod
```

ä¸€å¼€å§‹å¯èƒ½æ˜¯ContainerCreatingçŠ¶æ€ï¼Œè¿‡ä¸€é˜µåº”è¯¥å˜æˆRunningçŠ¶æ€ã€‚å¦‚æœæœ‰é—®é¢˜å¯ä»¥ç”¨kubectl describe podsçœ‹é—®é¢˜ã€‚

### å¾—åˆ°Serviceçš„url

```
$ minikube service hello-minikube --url
http://192.168.39.82:30740
```

ç„¶åç”¨æµè§ˆå™¨æ‰“å¼€ï¼š


<a name='img1'>![](/img/minikube/1.png)</a>
 
